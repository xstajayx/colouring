<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Kids Coloring Book</title>

  <style>
    :root {
      color-scheme: light;
      --bg: #f4f3ff;
      --card: #ffffff;
      --ink: #1f1f2b;
      --muted: #6b6b7d;
      --accent: #7b5cff;
      --accent-soft: #efeaff;
      --outline: #e1def2;
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: var(--bg);
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 0;
      margin: 0;
      color: var(--ink);
    }

    .app {
      width: min(1100px, 100%);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .hero {
      background: linear-gradient(135deg, #ffffff 0%, #f1ecff 100%);
      border-radius: 22px;
      padding: 22px 26px;
      box-shadow: 0 18px 40px rgba(55, 32, 120, 0.08);
      display: flex;
      justify-content: space-between;
      gap: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .hero h1 {
      font-size: 28px;
      margin: 0 0 6px;
    }

    .hero p {
      margin: 0;
      color: var(--muted);
    }

    .hero .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent-soft);
      color: var(--accent);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .panel {
      background: var(--card);
      border-radius: 20px;
      padding: 16px 18px;
      border: 1px solid var(--outline);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .workspace {
      display: grid;
      grid-template-columns: minmax(220px, 260px) minmax(0, 1fr) minmax(220px, 260px);
      grid-template-areas:
        "pages pages pages"
        "tools canvas colors";
      gap: 18px;
      align-items: start;
    }

    .panel-pages {
      grid-area: pages;
    }

    .panel-tools {
      grid-area: tools;
    }

    .panel-colors {
      grid-area: colors;
    }

    .canvas-area {
      grid-area: canvas;
      display: flex;
      justify-content: center;
    }

    .section-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .section-title h2 {
      font-size: 18px;
      margin: 0;
    }

    .section-title span {
      color: var(--muted);
      font-size: 13px;
    }

    #toolbar, #toolbar2, #pages, #categories {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    #toolbar,
    #toolbar2 {
      align-items: center;
    }

    #categories {
      justify-content: flex-start;
    }

    .color-btn {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 2px solid #ddd;
      cursor: pointer;
      box-sizing: border-box;
    }

    .color-btn.active {
      border: 3px solid #555;
    }

    .tool-btn, .page-btn, .size-btn, .brush-btn, .sticker-btn, .category-btn, .shape-btn {
      border: none;
      padding: 6px 12px;
      border-radius: 12px;
      cursor: pointer;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    .tool-btn:hover,
    .page-btn:hover,
    .size-btn:hover,
    .brush-btn:hover,
    .sticker-btn:hover,
    .category-btn:hover,
    .shape-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.12);
    }

    .size-btn, .brush-btn {
      font-size: 12px;
    }

    .size-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      padding: 0;
      justify-content: center;
    }

    .tool-btn.active,
    .page-btn.active,
    .size-btn.active,
    .brush-btn.active,
    .sticker-btn.active,
    .category-btn.active,
    .shape-btn.active {
      background: var(--accent-soft);
      color: var(--accent);
    }

    #clear {
      background: #ff7676;
      color: white;
      font-weight: bold;
    }

    #save {
      background: #7ccf7c;
      color: white;
      font-weight: bold;
    }

    #canvas-wrapper {
      display: flex;
      justify-content: center;
      width: 100%;
    }

    #canvas-stack {
      position: relative;
      border: 1px solid #ddd;
      border-radius: 12px;
      overflow: hidden;
      background: white;
      touch-action: none;
      max-width: 100%;
      width: min(100%, 1000px);
      aspect-ratio: 700 / 450;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    #outlineCanvas,
    #drawCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      max-width: 100%;
    }

    #drawCanvas {
      z-index: 1;
    }

    #outlineCanvas {
      z-index: 2;
      pointer-events: none;
    }

    /* Make canvas responsive */
    @media (max-width: 750px) {
      #outlineCanvas,
      #drawCanvas {
        width: 100%;
        height: auto;
      }

      #canvas-stack {
        width: 100%;
      }
    }

    #colorPicker {
      padding: 0;
      width: 40px;
      height: 34px;
      border-radius: 8px;
      border: 1px solid #ccc;
      cursor: pointer;
    }

    .helper-note {
      font-size: 12px;
      color: var(--muted);
    }

    .panel-tools #toolbar2,
    .panel-colors #toolbar {
      flex-direction: column;
      align-items: stretch;
    }

    .panel-colors .tool-btn {
      justify-content: center;
    }

    #page-picker {
      margin-block: 1.5rem 2rem;
    }

    .category-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .category-btn {
      border: none;
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      font-size: 0.9rem;
      cursor: pointer;
      background: #f2f2ff;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
    }

    .category-btn.is-active {
      background: #7557ff;
      color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    .category-btn:hover {
      transform: translateY(-1px);
    }

    .page-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.9rem;
    }

    .page-card {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 0.6rem;
      border-radius: 1rem;
      border: 1px solid #e1e1ff;
      background: #ffffff;
      cursor: pointer;
      text-align: left;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
    }

    .page-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border-color: #c0c0ff;
    }

    .page-thumb {
      aspect-ratio: 4 / 3;
      border-radius: 0.8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      background: #faf8ff;
      margin-bottom: 0.5rem;
    }

    .page-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.4rem;
    }

    .page-info h3 {
      font-size: 0.95rem;
      margin: 0;
    }

    .badge {
      font-size: 0.7rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    .badge-easy {
      background: #e5ffe9;
      border-color: #b4f3c0;
    }

    .badge-medium {
      background: #fff8e6;
      border-color: #ffe1a3;
    }

    .badge-hard {
      background: #ffe6ea;
      border-color: #ffb6c4;
    }

    @media (max-width: 980px) {
      .workspace {
        grid-template-columns: 1fr;
        grid-template-areas:
          "pages"
          "canvas"
          "tools"
          "colors";
      }

      .panel-tools #toolbar2,
      .panel-colors #toolbar {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: flex-start;
      }
    }

    .app {
      width: 100%;
      min-height: 100vh;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 1rem;
      border-bottom: 1px solid #eee;
      background: #fff;
    }

    .app-header h1 {
      font-size: 1.2rem;
      margin: 0;
    }

    #change-picture-btn {
      border: none;
      border-radius: 999px;
      padding: 0.45rem 1rem;
      font-size: 0.9rem;
      font-weight: 600;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 8px 16px rgba(123, 92, 255, 0.25);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    #change-picture-btn:hover {
      background: #6b4bff;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      justify-content: center;
      padding: 0.4rem 0.6rem;
      border-bottom: 1px solid #eee;
      background: #fafafa;
    }

    .toolbar button {
      border: 1px solid #ddd;
      border-radius: 999px;
      padding: 0.25rem 0.7rem;
      font-size: 0.85rem;
      background: #fff;
      cursor: pointer;
      box-shadow: none;
      transition: background 0.12s ease;
    }

    .toolbar button:hover {
      background: #f0f0ff;
    }

    .toolbar button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f4f4f8;
    }

    .toolbar-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
      justify-content: center;
    }

    .toolbar .color-btn,
    .toolbar .size-btn {
      width: 28px;
      height: 28px;
      padding: 0;
      justify-content: center;
    }

    .toolbar .color-btn {
      border-radius: 50%;
    }

    .toolbar .tool-btn,
    .toolbar .brush-btn,
    .toolbar .shape-btn,
    .toolbar .sticker-btn {
      border-radius: 999px;
    }

    .app-main {
      max-width: 1100px;
      margin: 0.5rem auto 1.5rem;
      padding: 0 0.5rem;
      width: 100%;
    }

    .canvas-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      height: min(70vh, 700px);
    }


    .category-filters {
      gap: 0.4rem;
      margin-bottom: 0.5rem;
    }

    .category-btn {
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
    }

    .page-grid {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.4rem;
      overflow: auto;
      padding-top: 0.4rem;
    }

    .page-card {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      gap: 0.4rem;
      padding: 0.4rem 0.5rem;
      border-radius: 0.6rem;
      background: #fafafa;
      font-size: 0.85rem;
    }

    .page-thumb {
      font-size: 1.3rem;
      margin: 0;
    }

    .page-info {
      width: 100%;
    }

    .page-info h3 {
      font-size: 0.85rem;
    }

    .badge {
      font-size: 0.65rem;
    }

    .page-picker-panel {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .page-picker-panel.is-open {
      display: flex;
    }

    .page-picker-content {
      background: #fff;
      border-radius: 1rem;
      padding: 1rem;
      width: min(90vw, 700px);
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }

    .page-picker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .page-picker-header h2 {
      font-size: 1rem;
      margin: 0;
    }

    .page-picker-header button {
      border: none;
      background: transparent;
      font-size: 1.1rem;
      cursor: pointer;
    }

    .update-hub {
      display: grid;
      gap: 0.75rem;
      border-radius: 1rem;
      border: 1px solid #e9e5ff;
      background: #faf8ff;
      padding: 0.75rem 1rem;
    }

    .update-hub-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 0.6rem;
    }

    .update-hub-title {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.35rem;
    }

    .update-hub-title h2 {
      margin: 0;
      font-size: 1rem;
    }

    .update-meta {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      background: #efeaff;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
    }

    .update-grid {
      display: grid;
      gap: 0.6rem;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .update-card {
      background: #ffffff;
      border-radius: 0.8rem;
      padding: 0.6rem 0.8rem;
      border: 1px solid #e0dcff;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }

    .update-card strong {
      font-size: 0.9rem;
    }

    .update-card span {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .featured-drop {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      border-radius: 0.8rem;
      padding: 0.6rem 0.8rem;
      background: #ffffff;
      border: 1px dashed #c5baff;
    }

    .featured-drop .drop-emoji {
      font-size: 1.6rem;
    }

    .featured-drop p {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .tool-hint {
      font-size: 0.75rem;
      color: var(--muted);
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="app">
    <header class="app-header">
      <h1>Colouring</h1>
      <button id="change-picture-btn" type="button">üñºÔ∏è Choose picture</button>
    </header>

    <div class="toolbar">
      <div class="toolbar-group">
        <button class="tool-btn active" id="penTool">üñåÔ∏è Brush</button>
        <button class="tool-btn" id="lineTool">üìè Line</button>
        <button class="tool-btn" id="shapeTool">üî∫ Shapes</button>
        <button class="tool-btn" id="fillTool">ü™£ Fill</button>
        <button class="tool-btn" id="eraserTool">üßΩ Eraser</button>
        <button class="tool-btn" id="stickerTool">‚≠ê Stickers</button>
        <button class="tool-btn" id="mirrorToggle">ü™û Mirror</button>
        <button class="tool-btn" id="undo">‚Ü©Ô∏è Undo</button>
        <button class="tool-btn" id="redo">‚Ü™Ô∏è Redo</button>
        <button class="tool-btn" id="save">üíæ Save</button>
        <button class="tool-btn" id="clear">üßº Clear</button>
        <button class="tool-btn" id="surprisePalette">üé≤ Surprise Palette</button>
      </div>
      <div class="toolbar-group">
        <button class="size-btn active" data-size="4">S</button>
        <button class="size-btn" data-size="8">M</button>
        <button class="size-btn" data-size="14">L</button>

        <button class="brush-btn active" data-brush="normal">Smooth</button>
        <button class="brush-btn" data-brush="dashed">Dashed</button>
        <button class="brush-btn" data-brush="marker">Marker</button>
        <button class="brush-btn" data-brush="fuzzy">Fuzzy</button>
        <button class="brush-btn" data-brush="spray">Spray</button>

        <button class="shape-btn active" data-shape="rectangle">‚¨õ</button>
        <button class="shape-btn" data-shape="circle">‚ö™</button>
        <button class="shape-btn" data-shape="triangle">üî∫</button>

        <button class="sticker-btn" data-sticker="‚≠ê">‚≠ê</button>
        <button class="sticker-btn" data-sticker="‚ù§Ô∏è">‚ù§Ô∏è</button>
        <button class="sticker-btn" data-sticker="üòä">üòä</button>
        <button class="sticker-btn" data-sticker="üåà">üåà</button>
        <button class="sticker-btn" data-sticker="ü¶Ñ">ü¶Ñ</button>
        <button class="sticker-btn" data-sticker="üßÅ">üßÅ</button>
        <button class="sticker-btn" data-sticker="üéà">üéà</button>
        <button class="sticker-btn" data-sticker="‚öΩÔ∏è">‚öΩÔ∏è</button>
        <button class="sticker-btn" data-sticker="ü¶ã">ü¶ã</button>
        <button class="sticker-btn" data-sticker="üçÄ">üçÄ</button>
      </div>
      <div class="toolbar-group" id="toolbar">
        <div class="color-btn active" style="background:#000000" data-color="#000000"></div>
        <div class="color-btn" style="background:#ff4b4b" data-color="#ff4b4b"></div>
        <div class="color-btn" style="background:#ff9a2f" data-color="#ff9a2f"></div>
        <div class="color-btn" style="background:#ffd93b" data-color="#ffd93b"></div>
        <div class="color-btn" style="background:#4caf50" data-color="#4caf50"></div>
        <div class="color-btn" style="background:#2196f3" data-color="#2196f3"></div>
        <div class="color-btn" style="background:#9c27b0" data-color="#9c27b0"></div>
        <div class="color-btn" style="background:#ff6ec7" data-color="#ff6ec7"></div>
        <div class="color-btn" style="background:#8d6e63" data-color="#8d6e63"></div>
        <label class="tool-btn">
          üé®
          <input type="color" id="colorPicker" value="#000000" />
        </label>
      </div>
    </div>

    <main class="app-main">
      <section class="update-hub" aria-live="polite">
        <div class="update-hub-header">
          <div class="update-hub-title">
            <div class="update-meta" id="next-update">Next drop in 00:45</div>
            <h2>Pop Culture Update Hub</h2>
          </div>
          <div class="featured-drop" id="featured-drop">
            <div class="drop-emoji">üé¨</div>
            <div>
              <strong>Featured: Retro Arcade Quest</strong>
              <p>Pixel vibes, neon lights, and bonus zones.</p>
            </div>
          </div>
        </div>
        <div class="update-grid" id="update-feed">
          <div class="update-card">
            <strong>New today: Hero Tech Hangar</strong>
            <span>Detailed gadgets, glowing panels, and launch pads.</span>
          </div>
          <div class="update-card">
            <strong>Trending: Fantasy Academy</strong>
            <span>Library towers, magical pets, and spell books.</span>
          </div>
          <div class="update-card">
            <strong>Coming soon: Space Saga Cruiser</strong>
            <span>Hyperdrive, starports, and epic bridges.</span>
          </div>
        </div>
      </section>
      <p class="tool-hint">Tip: Try Mirror mode for symmetrical designs, or use Spray for glittery textures.</p>
      <div class="canvas-wrapper">
        <div id="canvas-wrapper">
          <div id="canvas-stack">
            <canvas id="drawCanvas" width="900" height="580"></canvas>
            <canvas id="outlineCanvas" width="900" height="580"></canvas>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div id="page-picker-panel" class="page-picker-panel">
    <div class="page-picker-content">
      <header class="page-picker-header">
        <h2>Choose a picture</h2>
        <button id="close-page-picker" type="button">‚úï</button>
      </header>

      <div class="category-filters">
        <button class="category-btn is-active" data-category="all">‚ú® All</button>
        <button class="category-btn" data-category="animals">Animals</button>
        <button class="category-btn" data-category="vehicles">Vehicles</button>
        <button class="category-btn" data-category="shapes">Shapes</button>
        <button class="category-btn" data-category="scenes">Scenes</button>
        <button class="category-btn" data-category="pop">Pop Culture</button>
        <button class="category-btn" data-category="teens">Teens</button>
        <button class="category-btn" data-category="blank">Blank</button>
      </div>

      <div class="page-grid">
        <!-- Animals -->
        <button class="page-card"
                data-page-id="cat-easy"
                data-category="animals">
          <div class="page-thumb placeholder-thumb">üê±</div>
          <div class="page-info">
            <h3>Cat</h3>
            <span class="badge badge-easy">Easy</span>
          </div>
        </button>

        <button class="page-card"
                data-page-id="dino-hard"
                data-category="animals">
          <div class="page-thumb placeholder-thumb">ü¶ï</div>
          <div class="page-info">
            <h3>Dino</h3>
            <span class="badge badge-hard">Hard</span>
          </div>
        </button>

        <!-- Vehicles -->
        <button class="page-card"
                data-page-id="car"
                data-category="vehicles">
          <div class="page-thumb placeholder-thumb">üöó</div>
          <div class="page-info">
            <h3>Car</h3>
            <span class="badge badge-medium">Medium</span>
          </div>
        </button>

        <button class="page-card"
                data-page-id="rocket"
                data-category="vehicles">
          <div class="page-thumb placeholder-thumb">üöÄ</div>
          <div class="page-info">
            <h3>Rocket</h3>
            <span class="badge badge-medium">Medium</span>
          </div>
        </button>

        <!-- Shapes -->
        <button class="page-card"
                data-page-id="shapes-easy"
                data-category="shapes">
          <div class="page-thumb placeholder-thumb">üî∫</div>
          <div class="page-info">
            <h3>Shapes (Easy)</h3>
            <span class="badge badge-easy">Easy</span>
          </div>
        </button>

        <button class="page-card"
                data-page-id="shapes-challenge"
                data-category="shapes">
          <div class="page-thumb placeholder-thumb">üß©</div>
          <div class="page-info">
            <h3>Shapes (Challenge)</h3>
            <span class="badge badge-hard">Challenge</span>
          </div>
        </button>

        <!-- Scenes -->
        <button class="page-card"
                data-page-id="house-scene"
                data-category="scenes">
          <div class="page-thumb placeholder-thumb">üè†</div>
          <div class="page-info">
            <h3>House Scene</h3>
            <span class="badge badge-medium">Scene</span>
          </div>
        </button>

        <button class="page-card"
                data-page-id="rainbow-scene"
                data-category="scenes">
          <div class="page-thumb placeholder-thumb">üåà</div>
          <div class="page-info">
            <h3>Rainbow Scene</h3>
            <span class="badge badge-easy">Fun</span>
          </div>
        </button>

        <!-- Teens / Mandala -->
        <button class="page-card"
                data-page-id="mandala-vibes"
                data-category="teens">
          <div class="page-thumb placeholder-thumb">üåÄ</div>
          <div class="page-info">
            <h3>Mandala Vibes</h3>
            <span class="badge badge-hard">Detail</span>
          </div>
        </button>

        <button class="page-card"
                data-page-id="city-night"
                data-category="teens">
          <div class="page-thumb placeholder-thumb">üåÉ</div>
          <div class="page-info">
            <h3>City Night</h3>
            <span class="badge badge-medium">Teens</span>
          </div>
        </button>

        <!-- Pop culture -->
        <button class="page-card"
                data-page-id="space-saga"
                data-category="pop">
          <div class="page-thumb placeholder-thumb">üöÄ</div>
          <div class="page-info">
            <h3>Space Saga Cruiser</h3>
            <span class="badge badge-hard">Epic</span>
          </div>
        </button>

        <button class="page-card"
                data-page-id="fantasy-academy"
                data-category="pop">
          <div class="page-thumb placeholder-thumb">üßô</div>
          <div class="page-info">
            <h3>Fantasy Academy</h3>
            <span class="badge badge-medium">Magical</span>
          </div>
        </button>

        <button class="page-card"
                data-page-id="hero-tech"
                data-category="pop">
          <div class="page-thumb placeholder-thumb">ü¶æ</div>
          <div class="page-info">
            <h3>Hero Tech Hangar</h3>
            <span class="badge badge-hard">Gear</span>
          </div>
        </button>

        <button class="page-card"
                data-page-id="retro-arcade"
                data-category="pop">
          <div class="page-thumb placeholder-thumb">üïπÔ∏è</div>
          <div class="page-info">
            <h3>Retro Arcade Quest</h3>
            <span class="badge badge-medium">Neon</span>
          </div>
        </button>

        <!-- Blank -->
        <button class="page-card"
                data-page-id="blank"
                data-category="blank">
          <div class="page-thumb placeholder-thumb">‚úèÔ∏è</div>
          <div class="page-info">
            <h3>Blank Canvas</h3>
            <span class="badge badge-easy">Free Draw</span>
          </div>
        </button>
      </div>
    </div>
  </div>

  <script>
    const outlineCanvas = document.getElementById("outlineCanvas");
    const drawCanvas = document.getElementById("drawCanvas");
    const outlineCtx = outlineCanvas.getContext("2d");
    const drawCtx = drawCanvas.getContext("2d");
    const undoButton = document.getElementById("undo");
    const redoButton = document.getElementById("redo");

    let drawing = false;
    let currentColor = "#000000";
    let brushSize = 8;
    let currentTool = "draw"; // draw, line, shape, fill, eraser, sticker
    let currentSticker = "‚≠ê";
    let currentBrush = "normal";
    let currentPage = "catEasy";
    let currentShape = "rectangle";
    let shapeStart = null;
    let drawingSnapshot = null;
    let mirrorMode = false;
    let undoStack = [];
    let redoStack = [];
    const maxHistory = 25;
    let lastPos = null;

    // --- Helpers: coordinates ---
    function getPos(e) {
      const rect = drawCanvas.getBoundingClientRect();
      const touchPoint =
        (e.touches && e.touches[0]) ||
        (e.changedTouches && e.changedTouches[0]);
      const clientX = touchPoint ? touchPoint.clientX : e.clientX;
      const clientY = touchPoint ? touchPoint.clientY : e.clientY;
      return {
        x: (clientX - rect.left) * (drawCanvas.width / rect.width),
        y: (clientY - rect.top) * (drawCanvas.height / rect.height)
      };
    }

    const baseCanvasWidth = 700;
    const baseCanvasHeight = 450;

    // --- Draw page outlines on OUTLINE canvas only ---
    function addRoundedRect(ctx, x, y, width, height, radius) {
      if (ctx.roundRect) {
        ctx.roundRect(x, y, width, height, radius);
        return;
      }
      const r = Math.min(radius, width / 2, height / 2);
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + width - r, y);
      ctx.arcTo(x + width, y, x + width, y + r, r);
      ctx.lineTo(x + width, y + height - r);
      ctx.arcTo(x + width, y + height, x + width - r, y + height, r);
      ctx.lineTo(x + r, y + height);
      ctx.arcTo(x, y + height, x, y + height - r, r);
      ctx.lineTo(x, y + r);
      ctx.arcTo(x, y, x + r, y, r);
    }

    function drawOutline(page, { clearDrawing = true } = {}) {
      const scaleX = outlineCanvas.width / baseCanvasWidth;
      const scaleY = outlineCanvas.height / baseCanvasHeight;

      outlineCtx.save();
      outlineCtx.setTransform(1, 0, 0, 1, 0, 0);
      outlineCtx.clearRect(0, 0, outlineCanvas.width, outlineCanvas.height);
      outlineCtx.setTransform(scaleX, 0, 0, scaleY, 0, 0);
      // white background
      outlineCtx.fillStyle = "white";
      outlineCtx.fillRect(0, 0, baseCanvasWidth, baseCanvasHeight);

      outlineCtx.strokeStyle = "#bbbbbb";
      outlineCtx.lineWidth = 3;
      outlineCtx.lineCap = "round";
      outlineCtx.lineJoin = "round";
      outlineCtx.beginPath();

      if (page === "catEasy") {
        // simple cat
        outlineCtx.arc(350, 230, 100, 0, Math.PI * 2);
        // ears
        outlineCtx.moveTo(290, 170);
        outlineCtx.lineTo(270, 130);
        outlineCtx.lineTo(310, 150);
        outlineCtx.moveTo(410, 170);
        outlineCtx.lineTo(430, 130);
        outlineCtx.lineTo(390, 150);
        // eyes
        outlineCtx.moveTo(320, 220);
        outlineCtx.arc(310, 220, 10, 0, Math.PI * 2);
        outlineCtx.moveTo(390, 220);
        outlineCtx.arc(380, 220, 10, 0, Math.PI * 2);
        // nose + mouth
        outlineCtx.moveTo(345, 240);
        outlineCtx.lineTo(355, 240);
        outlineCtx.lineTo(350, 250);
        outlineCtx.moveTo(350, 250);
        outlineCtx.quadraticCurveTo(335, 265, 320, 270);
        outlineCtx.moveTo(350, 250);
        outlineCtx.quadraticCurveTo(365, 265, 380, 270);
      } else if (page === "dinoHard") {
        // dinosaur body
        outlineCtx.moveTo(150, 300);
        outlineCtx.quadraticCurveTo(220, 180, 350, 170);
        outlineCtx.quadraticCurveTo(500, 180, 560, 300);
        outlineCtx.lineTo(150, 300);
        // tail
        outlineCtx.moveTo(150, 300);
        outlineCtx.lineTo(90, 260);
        outlineCtx.lineTo(150, 260);
        // head
        outlineCtx.moveTo(350, 170);
        outlineCtx.lineTo(350, 120);
        outlineCtx.lineTo(400, 120);
        outlineCtx.lineTo(410, 150);
        outlineCtx.lineTo(380, 170);
        // leg 1
        outlineCtx.moveTo(260, 300);
        outlineCtx.lineTo(260, 340);
        outlineCtx.lineTo(290, 340);
        outlineCtx.lineTo(290, 300);
        // leg 2
        outlineCtx.moveTo(430, 300);
        outlineCtx.lineTo(430, 340);
        outlineCtx.lineTo(460, 340);
        outlineCtx.lineTo(460, 300);
        // eye
        outlineCtx.moveTo(365, 140);
        outlineCtx.arc(360, 140, 6, 0, Math.PI * 2);
        // plates
        outlineCtx.moveTo(220, 220);
        outlineCtx.lineTo(240, 190);
        outlineCtx.lineTo(260, 220);
        outlineCtx.moveTo(280, 205);
        outlineCtx.lineTo(300, 175);
        outlineCtx.lineTo(320, 205);
        outlineCtx.moveTo(340, 205);
        outlineCtx.lineTo(360, 175);
        outlineCtx.lineTo(380, 205);
      } else if (page === "car") {
        outlineCtx.moveTo(150, 280);
        outlineCtx.lineTo(550, 280);
        outlineCtx.lineTo(580, 250);
        outlineCtx.lineTo(520, 220);
        outlineCtx.lineTo(400, 220);
        outlineCtx.lineTo(360, 180);
        outlineCtx.lineTo(250, 180);
        outlineCtx.lineTo(220, 220);
        outlineCtx.lineTo(150, 230);
        outlineCtx.closePath();
        // wheels
        outlineCtx.moveTo(230, 280);
        outlineCtx.arc(230, 280, 40, 0, Math.PI * 2);
        outlineCtx.moveTo(470, 280);
        outlineCtx.arc(470, 280, 40, 0, Math.PI * 2);
        // window
        outlineCtx.moveTo(280, 220);
        outlineCtx.lineTo(350, 190);
        outlineCtx.lineTo(390, 190);
        outlineCtx.lineTo(390, 220);
        outlineCtx.closePath();
      } else if (page === "rocket") {
        // rocket body
        outlineCtx.moveTo(350, 100);
        outlineCtx.lineTo(420, 230);
        outlineCtx.lineTo(280, 230);
        outlineCtx.closePath();
        // window
        outlineCtx.moveTo(350, 170);
        outlineCtx.arc(350, 170, 20, 0, Math.PI * 2);
        // fins
        outlineCtx.moveTo(280, 230);
        outlineCtx.lineTo(240, 280);
        outlineCtx.lineTo(280, 260);
        outlineCtx.moveTo(420, 230);
        outlineCtx.lineTo(460, 280);
        outlineCtx.lineTo(420, 260);
        // flames
        outlineCtx.moveTo(280, 230);
        outlineCtx.quadraticCurveTo(350, 330, 420, 230);
      } else if (page === "shapesEasy") {
        // circle
        outlineCtx.arc(200, 170, 60, 0, Math.PI * 2);
        // square
        outlineCtx.rect(320, 110, 120, 120);
        // triangle
        outlineCtx.moveTo(520, 230);
        outlineCtx.lineTo(460, 110);
        outlineCtx.lineTo(580, 110);
        outlineCtx.closePath();
      } else if (page === "shapesHard") {
        // overlapping shapes
        outlineCtx.arc(200, 200, 70, 0, Math.PI * 2);
        outlineCtx.rect(260, 150, 140, 140);
        outlineCtx.moveTo(420, 260);
        outlineCtx.lineTo(520, 120);
        outlineCtx.lineTo(620, 260);
        outlineCtx.closePath();
        // star
        outlineCtx.moveTo(120, 330);
        outlineCtx.lineTo(140, 370);
        outlineCtx.lineTo(190, 370);
        outlineCtx.lineTo(150, 395);
        outlineCtx.lineTo(170, 435);
        outlineCtx.lineTo(120, 410);
        outlineCtx.lineTo(70, 435);
        outlineCtx.lineTo(90, 395);
        outlineCtx.lineTo(50, 370);
        outlineCtx.lineTo(100, 370);
        outlineCtx.closePath();
      } else if (page === "houseScene") {
        // house box
        outlineCtx.rect(220, 220, 200, 150);
        // roof
        outlineCtx.moveTo(220, 220);
        outlineCtx.lineTo(320, 140);
        outlineCtx.lineTo(420, 220);
        outlineCtx.closePath();
        // door
        outlineCtx.rect(260, 260, 60, 110);
        // windows
        outlineCtx.rect(340, 250, 60, 60);
        outlineCtx.moveTo(370, 250);
        outlineCtx.lineTo(370, 310);
        outlineCtx.moveTo(340, 280);
        outlineCtx.lineTo(400, 280);
        // ground
        outlineCtx.moveTo(80, 370);
        outlineCtx.lineTo(620, 370);
        // tree
        outlineCtx.rect(470, 260, 30, 80);
        outlineCtx.moveTo(485, 260);
        outlineCtx.arc(485, 230, 50, 0, Math.PI * 2);
      } else if (page === "rainbowScene") {
        // rainbow arcs
        outlineCtx.moveTo(100, 350);
        outlineCtx.arc(350, 350, 200, Math.PI, 2 * Math.PI);
        outlineCtx.moveTo(130, 350);
        outlineCtx.arc(350, 350, 170, Math.PI, 2 * Math.PI);
        outlineCtx.moveTo(160, 350);
        outlineCtx.arc(350, 350, 140, Math.PI, 2 * Math.PI);
        outlineCtx.moveTo(190, 350);
        outlineCtx.arc(350, 350, 110, Math.PI, 2 * Math.PI);
        // clouds
        outlineCtx.moveTo(120, 350);
        outlineCtx.arc(110, 350, 25, Math.PI, 0);
        outlineCtx.arc(140, 350, 25, Math.PI, 0);
        outlineCtx.arc(170, 350, 25, Math.PI, 0);
        outlineCtx.moveTo(530, 350);
        outlineCtx.arc(520, 350, 25, Math.PI, 0);
        outlineCtx.arc(550, 350, 25, Math.PI, 0);
        outlineCtx.arc(580, 350, 25, Math.PI, 0);
        // sun
        outlineCtx.moveTo(500, 100);
        outlineCtx.arc(500, 100, 40, 0, Math.PI * 2);
      } else if (page === "mandalaVibes") {
        // mandala rings
        outlineCtx.arc(350, 225, 140, 0, Math.PI * 2);
        outlineCtx.moveTo(350, 225);
        outlineCtx.arc(350, 225, 110, 0, Math.PI * 2);
        outlineCtx.moveTo(350, 225);
        outlineCtx.arc(350, 225, 80, 0, Math.PI * 2);
        outlineCtx.moveTo(350, 225);
        outlineCtx.arc(350, 225, 50, 0, Math.PI * 2);
        // petals
        for (let i = 0; i < 12; i++) {
          const angle = (Math.PI * 2 * i) / 12;
          const x = 350 + Math.cos(angle) * 140;
          const y = 225 + Math.sin(angle) * 140;
          outlineCtx.moveTo(350, 225);
          outlineCtx.lineTo(x, y);
          outlineCtx.moveTo(x, y);
          outlineCtx.arc(x, y, 18, 0, Math.PI * 2);
        }
      } else if (page === "cityNight") {
        // skyline
        outlineCtx.rect(80, 180, 90, 190);
        outlineCtx.rect(190, 140, 80, 230);
        outlineCtx.rect(290, 200, 110, 170);
        outlineCtx.rect(420, 120, 100, 250);
        outlineCtx.rect(540, 220, 80, 150);
        // windows
        for (let x = 100; x <= 150; x += 25) {
          for (let y = 200; y <= 330; y += 40) {
            outlineCtx.rect(x, y, 18, 18);
          }
        }
        for (let x = 210; x <= 250; x += 30) {
          for (let y = 160; y <= 330; y += 45) {
            outlineCtx.rect(x, y, 16, 20);
          }
        }
        // moon + stars
        outlineCtx.moveTo(560, 90);
        outlineCtx.arc(540, 90, 30, 0, Math.PI * 2);
        outlineCtx.moveTo(140, 90);
        outlineCtx.arc(140, 90, 6, 0, Math.PI * 2);
        outlineCtx.moveTo(240, 70);
        outlineCtx.arc(240, 70, 5, 0, Math.PI * 2);
        outlineCtx.moveTo(320, 90);
        outlineCtx.arc(320, 90, 4, 0, Math.PI * 2);
        outlineCtx.moveTo(420, 70);
        outlineCtx.arc(420, 70, 5, 0, Math.PI * 2);
      } else if (page === "spaceSaga") {
        // spaceship body
        addRoundedRect(outlineCtx, 150, 160, 400, 140, 70);
        addRoundedRect(outlineCtx, 220, 130, 260, 80, 40);
        outlineCtx.moveTo(220, 230);
        outlineCtx.lineTo(150, 300);
        outlineCtx.lineTo(210, 300);
        outlineCtx.moveTo(480, 230);
        outlineCtx.lineTo(550, 300);
        outlineCtx.lineTo(490, 300);
        // windows
        for (let i = 0; i < 5; i++) {
          outlineCtx.moveTo(230 + i * 60, 230);
          outlineCtx.arc(230 + i * 60, 230, 18, 0, Math.PI * 2);
        }
        // star field
        for (let i = 0; i < 14; i++) {
          const x = 80 + (i * 40) % 560;
          const y = 60 + (i * 35) % 90;
          outlineCtx.moveTo(x + 4, y);
          outlineCtx.arc(x, y, 4, 0, Math.PI * 2);
        }
      } else if (page === "fantasyAcademy") {
        // towers
        outlineCtx.rect(130, 170, 120, 200);
        outlineCtx.rect(270, 140, 160, 230);
        outlineCtx.rect(450, 190, 90, 180);
        // roofs
        outlineCtx.moveTo(130, 170);
        outlineCtx.lineTo(190, 110);
        outlineCtx.lineTo(250, 170);
        outlineCtx.closePath();
        outlineCtx.moveTo(270, 140);
        outlineCtx.lineTo(350, 80);
        outlineCtx.lineTo(430, 140);
        outlineCtx.closePath();
        outlineCtx.moveTo(450, 190);
        outlineCtx.lineTo(495, 140);
        outlineCtx.lineTo(540, 190);
        outlineCtx.closePath();
        // banner + windows
        outlineCtx.moveTo(250, 240);
        outlineCtx.lineTo(430, 240);
        outlineCtx.moveTo(260, 240);
        outlineCtx.lineTo(260, 280);
        outlineCtx.moveTo(420, 240);
        outlineCtx.lineTo(420, 280);
        for (let x = 160; x <= 500; x += 60) {
          outlineCtx.rect(x, 210, 30, 40);
        }
        // owl
        outlineCtx.moveTo(110, 110);
        outlineCtx.arc(110, 110, 20, 0, Math.PI * 2);
        outlineCtx.moveTo(100, 110);
        outlineCtx.arc(100, 110, 5, 0, Math.PI * 2);
        outlineCtx.moveTo(120, 110);
        outlineCtx.arc(120, 110, 5, 0, Math.PI * 2);
      } else if (page === "heroTech") {
        // hangar
        addRoundedRect(outlineCtx, 120, 170, 460, 200, 24);
        outlineCtx.moveTo(120, 220);
        outlineCtx.lineTo(580, 220);
        outlineCtx.moveTo(120, 270);
        outlineCtx.lineTo(580, 270);
        // mech silhouette
        addRoundedRect(outlineCtx, 280, 190, 120, 140, 20);
        outlineCtx.moveTo(300, 190);
        outlineCtx.lineTo(300, 150);
        outlineCtx.lineTo(380, 150);
        outlineCtx.lineTo(380, 190);
        outlineCtx.moveTo(280, 250);
        outlineCtx.lineTo(240, 290);
        outlineCtx.moveTo(400, 250);
        outlineCtx.lineTo(440, 290);
        // control panels
        outlineCtx.rect(150, 300, 60, 40);
        outlineCtx.rect(500, 300, 60, 40);
        outlineCtx.moveTo(165, 320);
        outlineCtx.lineTo(195, 320);
        outlineCtx.moveTo(515, 320);
        outlineCtx.lineTo(545, 320);
      } else if (page === "retroArcade") {
        // arcade cabinet
        addRoundedRect(outlineCtx, 220, 120, 220, 280, 24);
        outlineCtx.rect(250, 150, 160, 120);
        outlineCtx.moveTo(250, 290);
        outlineCtx.lineTo(410, 290);
        // joystick + buttons
        outlineCtx.moveTo(290, 330);
        outlineCtx.arc(290, 330, 14, 0, Math.PI * 2);
        outlineCtx.moveTo(320, 330);
        outlineCtx.lineTo(320, 300);
        outlineCtx.moveTo(360, 330);
        outlineCtx.arc(360, 330, 12, 0, Math.PI * 2);
        outlineCtx.moveTo(390, 330);
        outlineCtx.arc(390, 330, 12, 0, Math.PI * 2);
        // neon stars
        for (let i = 0; i < 6; i++) {
          const x = 120 + i * 90;
          const y = 90 + (i % 2) * 30;
          outlineCtx.moveTo(x, y);
          outlineCtx.lineTo(x + 10, y + 20);
          outlineCtx.lineTo(x - 10, y + 20);
          outlineCtx.closePath();
        }
      } else if (page === "headphones") {
        // headband
        outlineCtx.moveTo(200, 220);
        outlineCtx.arc(350, 220, 150, Math.PI, 2 * Math.PI);
        outlineCtx.moveTo(240, 220);
        outlineCtx.arc(350, 220, 110, Math.PI, 2 * Math.PI);
        // ear pads
        addRoundedRect(outlineCtx, 190, 210, 60, 140, 20);
        addRoundedRect(outlineCtx, 450, 210, 60, 140, 20);
        // speaker detail
        outlineCtx.moveTo(220, 250);
        outlineCtx.arc(220, 280, 18, 0, Math.PI * 2);
        outlineCtx.moveTo(480, 250);
        outlineCtx.arc(480, 280, 18, 0, Math.PI * 2);
        // cord
        outlineCtx.moveTo(350, 360);
        outlineCtx.quadraticCurveTo(370, 400, 400, 420);
      } else if (page === "skateboard") {
        addRoundedRect(outlineCtx, 160, 210, 380, 80, 40);
        outlineCtx.moveTo(220, 290);
        outlineCtx.arc(220, 310, 30, 0, Math.PI * 2);
        outlineCtx.moveTo(480, 290);
        outlineCtx.arc(480, 310, 30, 0, Math.PI * 2);
        outlineCtx.moveTo(220, 310);
        outlineCtx.arc(220, 310, 12, 0, Math.PI * 2);
        outlineCtx.moveTo(480, 310);
        outlineCtx.arc(480, 310, 12, 0, Math.PI * 2);
        outlineCtx.moveTo(250, 250);
        outlineCtx.lineTo(450, 250);
      } else if (page === "blank") {
        // no outline, just white background already filled
      }

      outlineCtx.stroke();
      outlineCtx.restore();

      // important: clear children‚Äôs drawing layer when page changes
      if (clearDrawing) {
        clearDrawingLayer();
      }
    }

    function clearDrawingLayer() {
      drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
    }

    function pushHistory() {
      if (undoStack.length >= maxHistory) {
        undoStack.shift();
      }
      undoStack.push(drawCtx.getImageData(0, 0, drawCanvas.width, drawCanvas.height));
      redoStack = [];
      updateHistoryButtons();
    }

    function restoreFromStack(stackFrom, stackTo) {
      if (!stackFrom.length) return;
      stackTo.push(drawCtx.getImageData(0, 0, drawCanvas.width, drawCanvas.height));
      const imageData = stackFrom.pop();
      drawCtx.putImageData(imageData, 0, 0);
      updateHistoryButtons();
    }

    function updateHistoryButtons() {
      undoButton.disabled = undoStack.length === 0;
      redoButton.disabled = redoStack.length === 0;
    }

    // --- Drawing & stickers on DRAW canvas only ---
    function startDraw(e) {
      e.preventDefault();
      const pos = getPos(e);

      if (currentTool === "sticker") {
        pushHistory();
        drawCtx.save();
        const stickerSize = Math.min(96, Math.max(24, brushSize * 6));
        drawCtx.font = `${stickerSize}px "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", Arial, sans-serif`;
        drawCtx.textAlign = "center";
        drawCtx.textBaseline = "middle";
        drawCtx.fillText(currentSticker, pos.x, pos.y);
        if (mirrorMode) {
          drawCtx.fillText(currentSticker, drawCanvas.width - pos.x, pos.y);
        }
        drawCtx.restore();
        return;
      }

      if (currentTool === "fill") {
        pushHistory();
        floodFill(Math.floor(pos.x), Math.floor(pos.y), currentColor);
        if (mirrorMode) {
          floodFill(Math.floor(drawCanvas.width - pos.x), Math.floor(pos.y), currentColor);
        }
        return;
      }

      drawing = true;
      shapeStart = pos;
      lastPos = pos;
      pushHistory();
      drawingSnapshot =
        currentTool === "line" || currentTool === "shape"
          ? drawCtx.getImageData(0, 0, drawCanvas.width, drawCanvas.height)
          : null;
      setupBrush();
      drawCtx.beginPath();
      drawCtx.moveTo(pos.x, pos.y);
      draw(e);
    }

    function setupBrush() {
      drawCtx.setLineDash([]);
      drawCtx.globalAlpha = 1.0;
      drawCtx.lineCap = "round";
      drawCtx.lineJoin = "round";

      if (currentTool === "eraser") {
        drawCtx.strokeStyle = "#ffffff"; // ONLY erases drawing layer
        drawCtx.lineWidth = brushSize * 1.4;
        return;
      }

      // drawing
      drawCtx.strokeStyle = currentColor;
      drawCtx.lineWidth = brushSize;

      if (currentBrush === "dashed") {
        drawCtx.setLineDash([brushSize * 1.5, brushSize * 1.2]);
      } else if (currentBrush === "marker") {
        drawCtx.globalAlpha = 0.6;
        drawCtx.lineWidth = brushSize * 1.3;
      } else if (currentBrush === "fuzzy") {
        // main stroke normal, fuzzy effect handled in draw()
      } else if (currentBrush === "spray") {
        drawCtx.globalAlpha = 0.6;
        drawCtx.lineWidth = 1;
      }
    }

    function renderShape(pos, finalize = false) {
      if (!shapeStart) return;
      setupBrush();
      drawCtx.beginPath();

      if (currentTool === "line") {
        drawCtx.moveTo(shapeStart.x, shapeStart.y);
        drawCtx.lineTo(pos.x, pos.y);
      } else if (currentShape === "rectangle") {
        const width = pos.x - shapeStart.x;
        const height = pos.y - shapeStart.y;
        drawCtx.rect(shapeStart.x, shapeStart.y, width, height);
      } else if (currentShape === "circle") {
        const radius = Math.hypot(pos.x - shapeStart.x, pos.y - shapeStart.y);
        drawCtx.arc(shapeStart.x, shapeStart.y, radius, 0, Math.PI * 2);
      } else if (currentShape === "triangle") {
        const midpointX = (shapeStart.x + pos.x) / 2;
        drawCtx.moveTo(midpointX, shapeStart.y);
        drawCtx.lineTo(pos.x, pos.y);
        drawCtx.lineTo(shapeStart.x, pos.y);
        drawCtx.closePath();
      }

      drawCtx.stroke();
      if (mirrorMode) {
        drawCtx.beginPath();
        if (currentTool === "line") {
          drawCtx.moveTo(drawCanvas.width - shapeStart.x, shapeStart.y);
          drawCtx.lineTo(drawCanvas.width - pos.x, pos.y);
        } else if (currentShape === "rectangle") {
          const width = pos.x - shapeStart.x;
          const height = pos.y - shapeStart.y;
          drawCtx.rect(drawCanvas.width - shapeStart.x - width, shapeStart.y, width, height);
        } else if (currentShape === "circle") {
          const radius = Math.hypot(pos.x - shapeStart.x, pos.y - shapeStart.y);
          drawCtx.arc(drawCanvas.width - shapeStart.x, shapeStart.y, radius, 0, Math.PI * 2);
        } else if (currentShape === "triangle") {
          const midpointX = (shapeStart.x + pos.x) / 2;
          drawCtx.moveTo(drawCanvas.width - midpointX, shapeStart.y);
          drawCtx.lineTo(drawCanvas.width - pos.x, pos.y);
          drawCtx.lineTo(drawCanvas.width - shapeStart.x, pos.y);
          drawCtx.closePath();
        }
        drawCtx.stroke();
      }
      if (finalize) {
        drawCtx.closePath();
      }
    }

    function hexToRgb(hex) {
      const normalized = hex.replace("#", "");
      const bigint = parseInt(normalized.length === 3
        ? normalized.split("").map((c) => c + c).join("")
        : normalized, 16);
      return {
        r: (bigint >> 16) & 255,
        g: (bigint >> 8) & 255,
        b: bigint & 255
      };
    }

    function colorsMatch(data, index, target, tolerance = 16) {
      return (
        Math.abs(data[index] - target.r) <= tolerance &&
        Math.abs(data[index + 1] - target.g) <= tolerance &&
        Math.abs(data[index + 2] - target.b) <= tolerance
      );
    }

    function floodFill(startX, startY, hexColor) {
      const width = drawCanvas.width;
      const height = drawCanvas.height;

      const tempCanvas = document.createElement("canvas");
      tempCanvas.width = width;
      tempCanvas.height = height;
      const tempCtx = tempCanvas.getContext("2d");
      tempCtx.drawImage(drawCanvas, 0, 0);
      tempCtx.drawImage(outlineCanvas, 0, 0);

      const merged = tempCtx.getImageData(0, 0, width, height);
      const drawData = drawCtx.getImageData(0, 0, width, height);
      const fill = hexToRgb(hexColor);

      const startIndex = (startY * width + startX) * 4;
      const target = {
        r: merged.data[startIndex],
        g: merged.data[startIndex + 1],
        b: merged.data[startIndex + 2],
      };

      if (colorsMatch(merged.data, startIndex, fill)) {
        return;
      }

      const stack = [{ x: startX, y: startY }];
      const tolerance = 18;

      while (stack.length) {
        const { x, y } = stack.pop();
        if (x < 0 || y < 0 || x >= width || y >= height) {
          continue;
        }
        const idx = (y * width + x) * 4;
        if (!colorsMatch(merged.data, idx, target, tolerance)) {
          continue;
        }

        merged.data[idx] = fill.r;
        merged.data[idx + 1] = fill.g;
        merged.data[idx + 2] = fill.b;
        merged.data[idx + 3] = 255;

        drawData.data[idx] = fill.r;
        drawData.data[idx + 1] = fill.g;
        drawData.data[idx + 2] = fill.b;
        drawData.data[idx + 3] = 255;

        stack.push({ x: x + 1, y });
        stack.push({ x: x - 1, y });
        stack.push({ x, y: y + 1 });
        stack.push({ x, y: y - 1 });
      }

      drawCtx.putImageData(drawData, 0, 0);
    }

    function draw(e) {
      e.preventDefault();
      if (!drawing) return;

      const pos = getPos(e);

      if (currentTool === "line" || currentTool === "shape") {
        if (drawingSnapshot) {
          drawCtx.putImageData(drawingSnapshot, 0, 0);
          renderShape(pos);
        }
        return;
      }

      if (currentBrush === "spray" && currentTool !== "eraser") {
        const density = Math.max(8, brushSize * 2);
        for (let i = 0; i < density; i++) {
          const offsetX = (Math.random() - 0.5) * brushSize * 2;
          const offsetY = (Math.random() - 0.5) * brushSize * 2;
          drawCtx.fillStyle = currentColor;
          drawCtx.beginPath();
          drawCtx.arc(pos.x + offsetX, pos.y + offsetY, Math.max(1, brushSize / 6), 0, Math.PI * 2);
          drawCtx.fill();
          if (mirrorMode) {
            drawCtx.beginPath();
            drawCtx.arc(drawCanvas.width - pos.x + offsetX, pos.y + offsetY, Math.max(1, brushSize / 6), 0, Math.PI * 2);
            drawCtx.fill();
          }
        }
        lastPos = pos;
        return;
      }

      if (currentBrush === "fuzzy" && currentTool !== "eraser") {
        // fuzzy effect: main line + two light offset lines
        drawCtx.save();
        drawCtx.setLineDash([]);
        drawCtx.globalAlpha = 1.0;
        drawCtx.lineWidth = brushSize;
        drawCtx.strokeStyle = currentColor;
        drawCtx.lineTo(pos.x, pos.y);
        drawCtx.stroke();
        drawCtx.beginPath();
        drawCtx.moveTo(pos.x, pos.y);

        drawCtx.globalAlpha = 0.3;
        drawCtx.lineWidth = brushSize * 0.7;
        drawCtx.lineTo(pos.x + 2, pos.y + 2);
        drawCtx.stroke();
        drawCtx.beginPath();
        drawCtx.moveTo(pos.x + 2, pos.y + 2);

        drawCtx.lineTo(pos.x - 2, pos.y - 2);
        drawCtx.stroke();
        drawCtx.beginPath();
        drawCtx.moveTo(pos.x - 2, pos.y - 2);
        drawCtx.restore();
        if (mirrorMode) {
          drawCtx.save();
          drawCtx.setLineDash([]);
          drawCtx.globalAlpha = 1.0;
          drawCtx.lineWidth = brushSize;
          drawCtx.strokeStyle = currentColor;
          drawCtx.beginPath();
          drawCtx.moveTo(drawCanvas.width - lastPos.x, lastPos.y);
          drawCtx.lineTo(drawCanvas.width - pos.x, pos.y);
          drawCtx.stroke();
          drawCtx.globalAlpha = 0.3;
          drawCtx.lineWidth = brushSize * 0.7;
          drawCtx.beginPath();
          drawCtx.moveTo(drawCanvas.width - lastPos.x + 2, lastPos.y + 2);
          drawCtx.lineTo(drawCanvas.width - pos.x + 2, pos.y + 2);
          drawCtx.stroke();
          drawCtx.beginPath();
          drawCtx.moveTo(drawCanvas.width - lastPos.x - 2, lastPos.y - 2);
          drawCtx.lineTo(drawCanvas.width - pos.x - 2, pos.y - 2);
          drawCtx.stroke();
          drawCtx.restore();
        }
      } else {
        // normal / dashed / marker / eraser
        drawCtx.lineTo(pos.x, pos.y);
        drawCtx.stroke();
        drawCtx.beginPath();
        drawCtx.moveTo(pos.x, pos.y);
        if (mirrorMode) {
          drawCtx.beginPath();
          drawCtx.moveTo(drawCanvas.width - lastPos.x, lastPos.y);
          drawCtx.lineTo(drawCanvas.width - pos.x, pos.y);
          drawCtx.stroke();
        }
      }

      lastPos = pos;
    }

    function endDraw(e) {
      if (e) e.preventDefault();
      if (drawing && (currentTool === "line" || currentTool === "shape")) {
        const pos = getPos(e);
        drawCtx.putImageData(drawingSnapshot, 0, 0);
        renderShape(pos, true);
      }
      drawing = false;
      shapeStart = null;
      drawingSnapshot = null;
      lastPos = null;
      drawCtx.beginPath();
    }

    function resizeCanvases() {
      const rect = drawCanvas.getBoundingClientRect();
      if (!rect.width || !rect.height) return;

      const ratio = window.devicePixelRatio || 1;
      const targetWidth = Math.round(rect.width * ratio);
      const targetHeight = Math.round(rect.height * ratio);

      if (drawCanvas.width === targetWidth && drawCanvas.height === targetHeight) {
        return;
      }

      const tempCanvas = document.createElement("canvas");
      tempCanvas.width = drawCanvas.width;
      tempCanvas.height = drawCanvas.height;
      tempCanvas.getContext("2d").drawImage(drawCanvas, 0, 0);

      drawCanvas.width = targetWidth;
      drawCanvas.height = targetHeight;
      outlineCanvas.width = targetWidth;
      outlineCanvas.height = targetHeight;

      drawCtx.drawImage(tempCanvas, 0, 0, targetWidth, targetHeight);
      drawOutline(currentPage, { clearDrawing: false });
    }

    window.addEventListener("resize", resizeCanvases);

    // --- Init first page ---
    resizeCanvases();

    // --- Colours ---
    const colorBtns = document.querySelectorAll(".color-btn");
    colorBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        currentColor = btn.dataset.color;
        if (currentTool === "eraser") {
          setActiveTool("draw");
        }
        colorBtns.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById("colorPicker").value = currentColor;
      });
    });

    const colorPicker = document.getElementById("colorPicker");
    colorPicker.addEventListener("input", (e) => {
      currentColor = e.target.value;
      if (currentTool === "eraser") {
        setActiveTool("draw");
      }
      colorBtns.forEach(b => b.classList.remove("active"));
    });

    // --- Brush sizes ---
    const sizeBtns = document.querySelectorAll(".size-btn");
    sizeBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        brushSize = parseInt(btn.dataset.size, 10);
        sizeBtns.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
      });
    });

    // --- Brush types ---
    const brushBtns = document.querySelectorAll(".brush-btn");
    const shapeBtns = document.querySelectorAll(".shape-btn");
    brushBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        currentBrush = btn.dataset.brush;
        brushBtns.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
      });
    });

    shapeBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        currentShape = btn.dataset.shape;
        shapeBtns.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        setActiveTool("shape");
      });
    });

    // --- Tools ---
    const penTool = document.getElementById("penTool");
    const lineTool = document.getElementById("lineTool");
    const shapeTool = document.getElementById("shapeTool");
    const fillTool = document.getElementById("fillTool");
    const eraserTool = document.getElementById("eraserTool");
    const stickerTool = document.getElementById("stickerTool");
    const mirrorToggle = document.getElementById("mirrorToggle");
    const stickerBtns = document.querySelectorAll(".sticker-btn");

    const toolButtons = [penTool, lineTool, shapeTool, fillTool, eraserTool, stickerTool];

    function setActiveTool(tool) {
      currentTool = tool;
      toolButtons.forEach((btn) => btn.classList.remove("active"));
      if (tool === "draw") {
        penTool.classList.add("active");
      } else if (tool === "line") {
        lineTool.classList.add("active");
      } else if (tool === "shape") {
        shapeTool.classList.add("active");
      } else if (tool === "fill") {
        fillTool.classList.add("active");
      } else if (tool === "eraser") {
        eraserTool.classList.add("active");
      } else if (tool === "sticker") {
        stickerTool.classList.add("active");
      }
    }

    penTool.addEventListener("click", () => {
      setActiveTool("draw");
    });

    lineTool.addEventListener("click", () => {
      setActiveTool("line");
    });

    shapeTool.addEventListener("click", () => {
      setActiveTool("shape");
    });

    fillTool.addEventListener("click", () => {
      setActiveTool("fill");
    });

    eraserTool.addEventListener("click", () => {
      setActiveTool("eraser");
    });

    stickerTool.addEventListener("click", () => {
      setActiveTool("sticker");
    });

    stickerBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        currentSticker = btn.dataset.sticker;
        setActiveTool("sticker");
        stickerBtns.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
      });
    });

    mirrorToggle.addEventListener("click", () => {
      mirrorMode = !mirrorMode;
      mirrorToggle.classList.toggle("active", mirrorMode);
    });

    undoButton.addEventListener("click", () => {
      restoreFromStack(undoStack, redoStack);
    });

    redoButton.addEventListener("click", () => {
      restoreFromStack(redoStack, undoStack);
    });

    const openPickerBtn = document.getElementById("change-picture-btn");
    const pickerPanel = document.getElementById("page-picker-panel");
    const closePickerBtn = document.getElementById("close-page-picker");

    function openPicker() {
      pickerPanel.classList.add("is-open");
    }

    function closePicker() {
      pickerPanel.classList.remove("is-open");
    }

    if (openPickerBtn) {
      openPickerBtn.addEventListener("click", openPicker);
    }

    if (closePickerBtn) {
      closePickerBtn.addEventListener("click", closePicker);
    }

    if (pickerPanel) {
      pickerPanel.addEventListener("click", (e) => {
        if (e.target === pickerPanel) {
          closePicker();
        }
      });
    }

    // Update this to match your real loader function:
    function loadColoringPage(pageId) {
      const pageMap = {
        "cat-easy": "catEasy",
        "dino-hard": "dinoHard",
        "shapes-easy": "shapesEasy",
        "shapes-challenge": "shapesHard",
        "house-scene": "houseScene",
        "rainbow-scene": "rainbowScene",
        "mandala-vibes": "mandalaVibes",
        "city-night": "cityNight",
        "space-saga": "spaceSaga",
        "fantasy-academy": "fantasyAcademy",
        "hero-tech": "heroTech",
        "retro-arcade": "retroArcade"
      };

      const mappedPage = pageMap[pageId] || pageId;
      currentPage = mappedPage;
      drawOutline(mappedPage);
      closePicker();
      console.log("Load page:", pageId);
    }

    // Filtering by category
    const categoryButtons = document.querySelectorAll(".category-btn");
    const pageCards = document.querySelectorAll(".page-card");

    categoryButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const category = btn.dataset.category;

        categoryButtons.forEach(b => b.classList.remove("is-active"));
        btn.classList.add("is-active");

        pageCards.forEach(card => {
          const cardCategory = card.dataset.category;
          const show = category === "all" || cardCategory === category;
          card.style.display = show ? "" : "none";
        });
      });
    });

    // Click a card to load that page
    pageCards.forEach(card => {
      card.addEventListener("click", () => {
        const pageId = card.dataset.pageId;
        loadColoringPage(pageId);
      });
    });

    // --- Clear (only drawing layer) ---
    document.getElementById("clear").addEventListener("click", () => {
      pushHistory();
      clearDrawingLayer();
    });

    // --- Save: merge OUTLINE + DRAW into one image ---
    document.getElementById("save").addEventListener("click", () => {
      const tempCanvas = document.createElement("canvas");
      tempCanvas.width = outlineCanvas.width;
      tempCanvas.height = outlineCanvas.height;
      const tempCtx = tempCanvas.getContext("2d");

      tempCtx.drawImage(outlineCanvas, 0, 0);
      tempCtx.drawImage(drawCanvas, 0, 0);

      const link = document.createElement("a");
      link.href = tempCanvas.toDataURL("image/png");
      link.download = "my-coloring.png";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    const surprisePaletteBtn = document.getElementById("surprisePalette");
    const paletteColors = [
      ["#2f2f2f", "#ff6f61", "#ffb347", "#ffe66d", "#6bd4ff", "#7b5cff", "#caffbf", "#ffadad", "#ffd6a5"],
      ["#0f172a", "#38bdf8", "#a855f7", "#f472b6", "#facc15", "#22c55e", "#f97316", "#e2e8f0", "#94a3b8"],
      ["#1b1b1f", "#ff4d6d", "#f9c74f", "#90be6d", "#43aa8b", "#577590", "#f94144", "#f3722c", "#277da1"]
    ];

    surprisePaletteBtn.addEventListener("click", () => {
      const colors = paletteColors[Math.floor(Math.random() * paletteColors.length)];
      const swatches = document.querySelectorAll(".color-btn");
      swatches.forEach((swatch, index) => {
        const color = colors[index % colors.length];
        swatch.dataset.color = color;
        swatch.style.background = color;
      });
      currentColor = colors[0];
      document.getElementById("colorPicker").value = currentColor;
      colorBtns.forEach(b => b.classList.remove("active"));
      swatches[0].classList.add("active");
    });

    const updateFeed = document.getElementById("update-feed");
    const featuredDrop = document.getElementById("featured-drop");
    const nextUpdateLabel = document.getElementById("next-update");
    const popCultureDrops = [
      {
        title: "Space Saga Cruiser",
        detail: "Star bridges, navigation pods, and panoramic decks.",
        emoji: "üõ∞Ô∏è",
        pageId: "space-saga",
        difficulty: "Epic"
      },
      {
        title: "Fantasy Academy",
        detail: "Spellbound towers, magical pets, and secret doors.",
        emoji: "üìö",
        pageId: "fantasy-academy",
        difficulty: "Magical"
      },
      {
        title: "Hero Tech Hangar",
        detail: "Power suits, command panels, and launch gear.",
        emoji: "ü¶æ",
        pageId: "hero-tech",
        difficulty: "Gear"
      },
      {
        title: "Retro Arcade Quest",
        detail: "Neon cabinets, pixel quests, and bonus lives.",
        emoji: "üïπÔ∏è",
        pageId: "retro-arcade",
        difficulty: "Neon"
      }
    ];

    let dropIndex = 0;

    function getNextMidnight() {
      const next = new Date();
      next.setHours(24, 0, 0, 0);
      return next.getTime();
    }

    let nextDropAt = getNextMidnight();

    function addUpdateCard(drop) {
      const card = document.createElement("div");
      card.className = "update-card";
      const title = document.createElement("strong");
      title.textContent = `New drop: ${drop.title}`;
      const detail = document.createElement("span");
      detail.textContent = drop.detail;
      card.append(title, detail);
      updateFeed.prepend(card);
    }

    function setFeaturedDrop(drop) {
      featuredDrop.innerHTML = `
        <div class="drop-emoji">${drop.emoji}</div>
        <div>
          <strong>Featured: ${drop.title}</strong>
          <p>${drop.detail}</p>
        </div>
      `;
    }

    function addAutoPage(drop) {
      const existing = document.querySelector(`.page-card[data-page-id="${drop.pageId}"]`);
      if (existing) {
        return;
      }
      const card = document.createElement("button");
      card.className = "page-card";
      card.dataset.pageId = drop.pageId;
      card.dataset.category = "pop";
      card.innerHTML = `
        <div class="page-thumb placeholder-thumb">${drop.emoji}</div>
        <div class="page-info">
          <h3>${drop.title}</h3>
          <span class="badge badge-medium">${drop.difficulty}</span>
        </div>
      `;
      card.addEventListener("click", () => {
        loadColoringPage(drop.pageId);
      });
      document.querySelector(".page-grid").prepend(card);
    }

    function tickUpdates() {
      const remaining = Math.max(0, nextDropAt - Date.now());
      const hours = Math.floor(remaining / 3600000);
      const minutes = Math.floor((remaining % 3600000) / 60000);
      nextUpdateLabel.textContent = `Next drop in ${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}`;
      if (remaining === 0) {
        const drop = popCultureDrops[dropIndex % popCultureDrops.length];
        dropIndex += 1;
        addUpdateCard(drop);
        addAutoPage(drop);
        setFeaturedDrop(drop);
        nextDropAt = getNextMidnight();
      }
    }

    setFeaturedDrop(popCultureDrops[0]);
    tickUpdates();
    setInterval(tickUpdates, 1000);
    updateHistoryButtons();

    // --- Events (mouse + touch) ---
    drawCanvas.addEventListener("mousedown", startDraw);
    drawCanvas.addEventListener("mousemove", draw);
    drawCanvas.addEventListener("mouseup", endDraw);
    drawCanvas.addEventListener("mouseleave", endDraw);

    drawCanvas.addEventListener("touchstart", startDraw, { passive:false });
    drawCanvas.addEventListener("touchmove", draw, { passive:false });
    drawCanvas.addEventListener("touchend", endDraw, { passive:false });
  </script>

</body>
</html>
